<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0a0a12">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.svg">
<link rel="apple-touch-icon" href="icons/icon-192.svg">
<title>ãƒªã‚¹ãƒ‹ãƒ³ã‚°ç‰¹è¨“</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a12;
  --surface: #14142a;
  --card: #1c1c38;
  --card-hover: #24244a;
  --border: #2a2a50;
  --accent: #f0c040;
  --accent-dim: #a88520;
  --accent-glow: rgba(240,192,64,0.12);
  --easy: #60c8f0;
  --easy-bg: rgba(96,200,240,0.12);
  --good: #40d880;
  --good-bg: rgba(64,216,128,0.12);
  --hard: #f09040;
  --hard-bg: rgba(240,144,64,0.12);
  --again: #f05050;
  --again-bg: rgba(240,80,80,0.12);
  --text: #e4e4f0;
  --text2: #8888a8;
  --text3: #505068;
  --radius: 14px;
  --radius-sm: 8px;
  --safe-b: env(safe-area-inset-bottom, 0px);
  --nav-h: 60px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:16px;line-height:1.5;overflow:hidden;touch-action:manipulation}
button{font-family:inherit;border:none;cursor:pointer;outline:none;-webkit-appearance:none;font-size:inherit}
input{font-family:inherit;font-size:inherit}
#app{height:100%;display:flex;flex-direction:column}
.screen{display:none;flex:1;overflow-y:auto;padding:20px 16px;padding-bottom:calc(var(--nav-h)+var(--safe-b)+40px);-webkit-overflow-scrolling:touch}
.screen.active{display:flex;flex-direction:column}
#nav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--nav-h)+var(--safe-b));padding-bottom:var(--safe-b);background:var(--surface);border-top:1px solid var(--border);display:flex;z-index:100}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:none;color:var(--text3);font-size:10px;font-weight:600;letter-spacing:0.04em;transition:color 0.2s}
.nav-btn.active{color:var(--accent)}
.nav-btn svg{width:22px;height:22px}
.ptitle{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;margin-bottom:16px}
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 20px;border-radius:var(--radius);font-weight:600;font-size:15px;transition:all 0.12s;min-height:52px}
.btn:active{transform:scale(0.97)}
.btn-accent{background:var(--accent);color:#0a0a12}
.btn-surface{background:var(--card);color:var(--text)}
.btn-block{width:100%}
.btn-sm{min-height:40px;padding:8px 14px;font-size:13px}
.tag{display:inline-block;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600;background:var(--surface);color:var(--text2);border:1px solid var(--border);transition:all 0.15s}
.tag.active{background:var(--accent-glow);color:var(--accent);border-color:var(--accent)}
.sec-label{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:10px}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--card);color:var(--text);padding:10px 20px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;z-index:300;transition:transform 0.3s ease;pointer-events:none;border:1px solid var(--border)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toggle-row{display:flex;background:var(--surface);border-radius:var(--radius-sm);padding:3px;margin-bottom:14px}
.toggle-row button{flex:1;padding:7px;border-radius:6px;background:none;color:var(--text2);font-size:12px;font-weight:600;transition:all 0.15s}
.toggle-row button.active{background:var(--card);color:var(--text)}
.hero{background:linear-gradient(145deg,var(--card) 0%,var(--surface) 100%);border-radius:var(--radius);padding:20px;margin-bottom:20px;position:relative;overflow:hidden}
.hero::after{content:'';position:absolute;top:-40%;right:-15%;width:180px;height:180px;background:radial-gradient(circle,var(--accent-glow) 0%,transparent 70%);pointer-events:none}
.hero-n{font-family:'JetBrains Mono',monospace;font-size:44px;font-weight:700;color:var(--accent);line-height:1}
.hero-sub{font-size:13px;color:var(--text2);margin-top:4px}
.stats-row{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
.stat{background:rgba(255,255,255,0.04);border-radius:var(--radius-sm);padding:6px 12px;font-size:12px;color:var(--text2)}
.stat b{color:var(--text)}
.schedule-card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:20px;display:flex;justify-content:space-around;text-align:center}
.sched-item .sched-n{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700}
.sched-item .sched-label{font-size:11px;color:var(--text2)}
.tags-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:20px}
.home-btns{display:flex;flex-direction:column;gap:10px}
.import-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:40px 20px;text-align:center;cursor:pointer}
.import-zone.dragover{border-color:var(--accent);background:var(--accent-glow)}
.import-zone svg{width:40px;height:40px;color:var(--text3);margin-bottom:12px}
.import-zone p{color:var(--text2);font-size:13px}
.import-result{margin-top:20px;padding:16px;border-radius:var(--radius);text-align:center;font-size:14px}
.import-result.ok{background:var(--good-bg);color:var(--good)}
.import-result.err{background:var(--again-bg);color:var(--again)}
.study-screen{justify-content:space-between;padding-top:12px}
.study-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.study-prog{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--text2)}
.study-close{width:36px;height:36px;border-radius:50%;background:var(--card);color:var(--text2);display:flex;align-items:center;justify-content:center}
.step-dots{display:flex;gap:6px;justify-content:center;margin-bottom:20px}
.sdot{width:7px;height:7px;border-radius:50%;background:var(--border);transition:all 0.25s}
.sdot.on{background:var(--accent);width:22px;border-radius:4px}
.sdot.done{background:var(--accent-dim)}
.study-body{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:14px;min-height:0;overflow-y:auto}
.audio-orb{width:72px;height:72px;border-radius:50%;background:var(--accent-glow);display:flex;align-items:center;justify-content:center}
.audio-orb.playing{animation:orb-pulse 1.4s ease-out infinite}
@keyframes orb-pulse{0%{box-shadow:0 0 0 0 rgba(240,192,64,0.3)}100%{box-shadow:0 0 0 28px rgba(240,192,64,0)}}
.audio-orb svg{width:32px;height:32px;color:var(--accent)}
.s-label{font-size:12px;color:var(--text3);font-weight:700;letter-spacing:0.08em;text-transform:uppercase}
.s-text{font-size:18px;font-weight:600;line-height:1.6;padding:0 4px;max-width:100%;word-break:break-word}
.s-text.ja{font-size:16px;color:var(--text2)}
.speed-pill{display:inline-flex;padding:3px 10px;border-radius:16px;background:var(--card);font-size:12px;font-weight:600;color:var(--text2)}
.word-tap{cursor:pointer;padding:1px 2px;border-radius:3px;transition:background 0.15s}
.word-tap:active{opacity:0.7}
.word-tap.marked{background:rgba(240,192,64,0.25);color:var(--accent)}
.study-ctrls{padding-top:12px;display:flex;flex-direction:column;gap:10px}
.ctrl-row{display:flex;gap:8px}
.ctrl-row .btn{flex:1}
.rate-row{display:flex;gap:6px}
.rate-btn{flex:1;min-height:52px;border-radius:var(--radius);font-weight:700;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all 0.15s;opacity:0.55}
.rate-btn:active{transform:scale(0.95)}
.rate-btn.suggest{opacity:1;transform:scale(1.04);box-shadow:0 0 16px rgba(255,255,255,0.05)}
.r-again{background:var(--again-bg);color:var(--again)}
.r-hard{background:var(--hard-bg);color:var(--hard)}
.r-good{background:var(--good-bg);color:var(--good)}
.r-easy{background:var(--easy-bg);color:var(--easy)}
.auto-screen{align-items:center;justify-content:center;text-align:center;gap:20px}
.auto-orb{width:120px;height:120px;border-radius:50%;background:var(--accent-glow);display:flex;align-items:center;justify-content:center}
.auto-orb.playing{animation:orb-pulse 1.4s ease-out infinite}
.auto-orb svg{width:48px;height:48px;color:var(--accent)}
.auto-transcript{font-size:16px;font-weight:600;margin-top:8px;padding:0 12px;line-height:1.6}
.auto-stop{width:80px;height:80px;border-radius:50%;background:var(--again-bg);color:var(--again);display:flex;align-items:center;justify-content:center;border:3px solid var(--again);margin-top:12px}
.auto-stop svg{width:32px;height:32px}
.data-tabs{display:flex;background:var(--surface);border-radius:var(--radius-sm);padding:3px;margin-bottom:16px}
.data-tab{flex:1;padding:8px 4px;border-radius:6px;background:none;color:var(--text2);font-size:12px;font-weight:600;text-align:center;transition:all 0.15s}
.data-tab.active{background:var(--card);color:var(--text)}
.data-section{display:none}
.data-section.active{display:block}
.item-row{background:var(--card);border-radius:var(--radius-sm);padding:12px;display:flex;align-items:flex-start;gap:10px;margin-bottom:6px}
.item-play{width:36px;height:36px;border-radius:50%;background:var(--accent-glow);color:var(--accent);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.item-info{flex:1;min-width:0}
.item-t{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-t2{font-size:12px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-tags{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
.mini-tag{font-size:10px;padding:2px 7px;border-radius:8px;background:var(--surface);color:var(--text3)}
.item-del{width:32px;height:32px;border-radius:50%;background:none;color:var(--text3);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.word-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--card);border-radius:var(--radius-sm);margin-bottom:4px}
.word-text{font-weight:600;font-size:14px}
.word-src{font-size:11px;color:var(--text3)}
.filter-row{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.dialog-bg{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px}
.dialog-box{background:var(--surface);border-radius:var(--radius);padding:20px;max-width:300px;width:100%}
.dialog-box h3{font-size:15px;margin-bottom:6px}
.dialog-box p{font-size:13px;color:var(--text2);margin-bottom:16px;white-space:pre-line}
.dialog-btns{display:flex;gap:10px}
.dialog-btns .btn{flex:1}
.fade{animation:fadeIn 0.25s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>
<div id="app">
<div id="screen-home" class="screen active">
  <div class="hero">
    <div class="hero-n" id="h-total">0</div>
    <div class="hero-sub">ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ²æ¸ˆã¿</div>
    <div class="stats-row">
      <div class="stat">æœªå­¦ç¿’ <b id="h-unseen">0</b></div>
      <div class="stat">å­¦ç¿’ä¸­ <b id="h-learning">0</b></div>
      <div class="stat">å®Œç’§ <b id="h-perfect">0</b></div>
    </div>
  </div>
  <div class="schedule-card">
    <div class="sched-item"><div class="sched-n" id="h-rev">0</div><div class="sched-label">å¾©ç¿’</div></div>
    <div class="sched-item"><div class="sched-n" id="h-new">0</div><div class="sched-label">æ–°è¦</div></div>
    <div class="sched-item"><div class="sched-n" id="h-day-total">0</div><div class="sched-label">æœ¬æ—¥åˆè¨ˆ</div></div>
  </div>
  <div class="sec-label">ã‚¿ã‚°çµã‚Šè¾¼ã¿</div>
  <div class="tags-wrap" id="tag-list"></div>
  <div class="sec-label">é †ç•ª</div>
  <div class="toggle-row" id="order-tog">
    <button class="active" data-v="scheduler">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©</button>
    <button data-v="random">ãƒ©ãƒ³ãƒ€ãƒ </button>
  </div>
  <div class="home-btns">
    <button class="btn btn-accent btn-block" id="btn-start">å­¦ç¿’é–‹å§‹</button>
    <button class="btn btn-surface btn-block" id="btn-auto">è‡ªå‹•å†ç”Ÿ</button>
    <button class="btn btn-surface btn-block" onclick="nav('import')">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  </div>
</div>
<div id="screen-import" class="screen">
  <div class="ptitle">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
  <div class="import-zone" id="imp-zone">
    <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16V4m0 0L8 8m4-4l4 4M4 18h16"/></svg>
    <p>JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</p>
  </div>
  <input type="file" id="file-in" accept=".json" multiple hidden>
  <div id="imp-result" style="display:none"></div>
</div>
<div id="screen-study" class="screen study-screen"></div>
<div id="screen-auto" class="screen auto-screen"></div>
<div id="screen-data" class="screen">
  <div class="ptitle">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
  <div class="data-tabs">
    <button class="data-tab active" data-tab="items">ã‚¢ã‚¤ãƒ†ãƒ </button>
    <button class="data-tab" data-tab="words">å˜èª</button>
    <button class="data-tab" data-tab="actions">æ“ä½œ</button>
  </div>
  <div id="dt-items" class="data-section active">
    <div class="filter-row" id="data-filter"></div>
    <div id="item-list"></div>
  </div>
  <div id="dt-words" class="data-section">
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <button class="btn btn-surface btn-sm" style="flex:1" id="btn-export-words">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="btn btn-sm" style="flex:1;background:var(--again-bg);color:var(--again)" id="btn-clear-words">å…¨å‰Šé™¤</button>
    </div>
    <div id="word-list"></div>
  </div>
  <div id="dt-actions" class="data-section">
    <div style="display:flex;flex-direction:column;gap:10px">
      <button class="btn btn-surface btn-block" id="btn-reset-progress">æˆç¸¾ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btn btn-block" style="background:var(--again-bg);color:var(--again)" id="btn-delete-all">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
      <div style="text-align:center;font-size:11px;color:var(--text3);margin-top:16px" id="app-ver"></div>
    </div>
  </div>
</div>
<nav id="nav">
  <button class="nav-btn active" data-s="home"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l9-9 9 9M5 10v10a1 1 0 001 1h3m10-11v10a1 1 0 01-1 1h-3m-4 0v-6h4v6"/></svg>ãƒ›ãƒ¼ãƒ </button>
  <button class="nav-btn" data-s="study"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2m6-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>å­¦ç¿’</button>
  <button class="nav-btn" data-s="data"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 12h16M4 17h10"/></svg>ãƒ‡ãƒ¼ã‚¿</button>
</nav>
</div>
<div id="toast" class="toast"></div>
<div id="dialog" class="dialog-bg" style="display:none"><div class="dialog-box"><h3 id="dlg-t"></h3><p id="dlg-m"></p><div class="dialog-btns"><button class="btn btn-surface btn-sm" id="dlg-no">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-sm" style="background:var(--again-bg);color:var(--again)" id="dlg-yes">å®Ÿè¡Œ</button></div></div></div>
<script>
// === FSRS-5 ===
const W=[0.4072,1.1829,3.1262,15.4722,7.2102,0.5316,1.0651,0.0589,1.5330,0.1436,1.0019,1.9395,0.1100,0.2969,2.2261,0.2898,3.0000,0.4656,0.6778];
const DECAY=-0.5, FACTOR=Math.pow(0.9,1/DECAY)-1;

class FSRS {
  constructor(w=W,dr=0.9){this.w=w;this.dr=dr}
  initDS(g){
    const raw=this.w[4]-Math.exp(this.w[5]*g)*(g-1);
    const d=this.clampD(isNaN(raw)?5:raw);
    return {d,s:this.initS(g)};
  }
  initS(g){return Math.max(this.w[g-1]||this.w[0],0.01)}
  clampD(d){return Math.min(Math.max(d,1),10)}
  nextD(d,g){return this.clampD(this.w[7]*this.initDS(4).d+(1-this.w[7])*(d-this.w[6]*(g-3)))}
  nextS(d,s,r,g){
    if(g===1) return Math.max(this.w[11]*Math.pow(d,-this.w[12])*(Math.pow(s+1,this.w[13])-1)*Math.exp((1-r)*this.w[14]),0.01);
    const hp=g===2?this.w[15]:1;
    const eb=g===4?this.w[16]:1;
    return Math.max(s*(1+Math.exp(this.w[8])*(11-d)*Math.pow(s,-this.w[9])*(Math.exp((1-r)*this.w[10])-1)*hp*eb),0.01);
  }
  R(s,t){return t<=0?1:Math.pow(1+FACTOR*t/s,DECAY)}
  review(card,g,today){
    if(!card||card.reviewCount===0){
      const ds=this.initDS(g);
      return{stability:ds.s,difficulty:ds.d,lastReview:today,reviewCount:1,lapseCount:g===1?1:0};
    }
    const el=today-card.lastReview;
    const r=this.R(card.stability,el);
    return{stability:this.nextS(this.nextD(card.difficulty,g),card.stability,r,g),difficulty:this.nextD(card.difficulty,g),lastReview:today,reviewCount:card.reviewCount+1,lapseCount:card.lapseCount+(g===1?1:0)};
  }
}

class Scheduler {
  constructor(fsrs,o={}){this.f=fsrs;this.nEvery=o.nEvery||4;this.maxNew=o.maxNew||20;this.maxRev=o.maxRev||200;this.sinceN=0;this.newT=0;this.revT=0}
  today(){return Math.floor(Date.now()/86400000)}
  stats(cards,evals,itemIds){
    const t=this.today();const ds=new Date();ds.setHours(0,0,0,0);const iso=ds.toISOString();
    const valid=itemIds?new Set(itemIds):null;
    let due=0,nw=0;
    const todayNewDone=new Set();
    evals.filter(e=>e.evaluatedAt>=iso).forEach(e=>{const c=cards.find(x=>x.itemId===e.itemId);if(c&&c.reviewCount<=1)todayNewDone.add(e.itemId)});
    for(const c of cards){
      if(valid&&!valid.has(c.itemId))continue;
      if(c.reviewCount===0){nw++;continue}
      if(c.stability>0&&this.f.R(c.stability,t-c.lastReview)<this.f.dr)due++;
    }
    const newAvail=Math.max(0,Math.min(nw,this.maxNew-todayNewDone.size));
    return{dueReview:due,newAvail,total:Math.min(due+newAvail,this.maxRev)};
  }
  pick(cards,evals,excl=[]){
    const t=this.today();const ex=new Set(excl);
    if(this.revT>=this.maxRev)return null;
    let revs=[],news=[];
    for(const c of cards){
      if(ex.has(c.itemId))continue;
      if(c.reviewCount===0){news.push(c);continue}
      const r=this.f.R(c.stability,t-c.lastReview);
      if(r<this.f.dr)revs.push({c,r,p:1-r});
    }
    revs.sort((a,b)=>b.p-a.p);
    this.sinceN++;
    const canNew=this.newT<this.maxNew&&news.length>0;
    if(this.sinceN>=this.nEvery&&canNew){this.sinceN=0;this.newT++;this.revT++;return news[0].itemId}
    if(revs.length>0){this.revT++;return revs[0].c.itemId}
    if(canNew){this.sinceN=0;this.newT++;this.revT++;return news[0].itemId}
    return null;
  }
  reset(){this.sinceN=0;this.newT=0;this.revT=0}
}
const fsrs=new FSRS(), sched=new Scheduler(fsrs);

// === IndexedDB ===
const DB='ListeningApp',DBV=2;let db=null;
function openDB(){return new Promise((ok,no)=>{
  const r=indexedDB.open(DB,DBV);
  r.onupgradeneeded=e=>{
    const d=e.target.result;
    if(!d.objectStoreNames.contains('items'))d.createObjectStore('items',{keyPath:'itemId'});
    if(d.objectStoreNames.contains('progress'))d.deleteObjectStore('progress');
    if(!d.objectStoreNames.contains('cards'))d.createObjectStore('cards',{keyPath:'itemId'});
    if(!d.objectStoreNames.contains('playLog')){const s=d.createObjectStore('playLog',{keyPath:'id',autoIncrement:true});s.createIndex('itemId','itemId')}
    if(!d.objectStoreNames.contains('evalLog')){const s=d.createObjectStore('evalLog',{keyPath:'id',autoIncrement:true});s.createIndex('itemId','itemId')}
    if(!d.objectStoreNames.contains('wordList')){const s=d.createObjectStore('wordList',{keyPath:'id',autoIncrement:true});s.createIndex('word','word');s.createIndex('itemId','sourceItemId')}
  };
  r.onsuccess=e=>{db=e.target.result;ok(db)};r.onerror=e=>no(e.target.error);
})}
const st=(s,m)=>db.transaction(s,m||'readonly').objectStore(s);
const ga=s=>new Promise((o,n)=>{const r=st(s).getAll();r.onsuccess=()=>o(r.result);r.onerror=()=>n(r.error)});
const gg=(s,k)=>new Promise((o,n)=>{const r=st(s).get(k);r.onsuccess=()=>o(r.result);r.onerror=()=>n(r.error)});
const pp=(s,d)=>new Promise((o,n)=>{const r=st(s,'readwrite').put(d);r.onsuccess=()=>o(r.result);r.onerror=()=>n(r.error)});
const dd=(s,k)=>new Promise((o,n)=>{const r=st(s,'readwrite').delete(k);r.onsuccess=()=>o();r.onerror=()=>n(r.error)});
const cc=s=>new Promise((o,n)=>{const r=st(s,'readwrite').clear();r.onsuccess=()=>o();r.onerror=()=>n(r.error)});
const addL=(s,d)=>new Promise((o,n)=>{const r=st(s,'readwrite').add(d);r.onsuccess=()=>o(r.result);r.onerror=()=>n(r.error)});
const byIdx=(s,i,k)=>new Promise((o,n)=>{const r=st(s).index(i).getAll(k);r.onsuccess=()=>o(r.result);r.onerror=()=>n(r.error)});

// === Nav ===
let curScr='home';
function nav(s){document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));document.getElementById('screen-'+s).classList.add('active');document.querySelector(`.nav-btn[data-s="${s}"]`)?.classList.add('active');curScr=s;if(s==='home')refreshHome();if(s==='data')refreshData()}
document.querySelectorAll('.nav-btn').forEach(b=>b.onclick=()=>nav(b.dataset.s));

// === Toast / Dialog ===
let tt;function toast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');clearTimeout(tt);tt=setTimeout(()=>t.classList.remove('show'),2000)}
function confirm_(t,m,fn){const d=document.getElementById('dialog');document.getElementById('dlg-t').textContent=t;document.getElementById('dlg-m').textContent=m;d.style.display='flex';document.getElementById('dlg-no').onclick=()=>d.style.display='none';document.getElementById('dlg-yes').onclick=()=>{d.style.display='none';fn()}}

// === Home ===
let selTags=new Set(),studyOrd='scheduler';
async function refreshHome(){
  const items=await ga('items'),cards=await ga('cards'),evals=await ga('evalLog');
  const cm={};cards.forEach(c=>cm[c.itemId]=c);
  for(const it of items){if(!cm[it.itemId]){const nc={itemId:it.itemId,stability:0,difficulty:0,lastReview:0,reviewCount:0,lapseCount:0};await pp('cards',nc);cm[it.itemId]=nc;cards.push(nc)}}
  let un=0,lr=0,pf=0;const ts=new Set();
  for(const it of items){
    (it.tags||[]).forEach(t=>ts.add(t));
    const c=cm[it.itemId];if(!c||c.reviewCount===0){un++;continue}
    const ie=evals.filter(e=>e.itemId===it.itemId).sort((a,b)=>b.evaluatedAt.localeCompare(a.evaluatedAt));
    if(ie.length>=3&&ie.slice(0,3).every(e=>e.rating>=3)){pf++;continue}
    lr++;
  }
  document.getElementById('h-total').textContent=items.length;
  document.getElementById('h-unseen').textContent=un;
  document.getElementById('h-learning').textContent=lr;
  document.getElementById('h-perfect').textContent=pf;
  sched.reset();const itemIds=items.map(i=>i.itemId);const ss=sched.stats(cards,evals,itemIds);
  document.getElementById('h-rev').textContent=ss.dueReview;
  document.getElementById('h-new').textContent=ss.newAvail;
  document.getElementById('h-day-total').textContent=ss.total;
  const tl=document.getElementById('tag-list');
  if(ts.size===0){tl.innerHTML='<span style="font-size:12px;color:var(--text3)">ã‚¿ã‚°ãªã—</span>';return}
  tl.innerHTML='';
  const all=Object.assign(document.createElement('span'),{className:'tag'+(selTags.size===0?' active':''),textContent:'ã™ã¹ã¦'});all.onclick=()=>{selTags.clear();refreshHome()};tl.appendChild(all);
  [...ts].sort().forEach(t=>{const e=Object.assign(document.createElement('span'),{className:'tag'+(selTags.has(t)?' active':''),textContent:t});e.onclick=()=>{selTags.has(t)?selTags.delete(t):selTags.add(t);refreshHome()};tl.appendChild(e)});
}
document.getElementById('order-tog').onclick=e=>{const b=e.target.closest('button');if(!b)return;studyOrd=b.dataset.v;document.querySelectorAll('#order-tog button').forEach(x=>x.classList.toggle('active',x===b))};

// === Import ===
const impZ=document.getElementById('imp-zone'),fIn=document.getElementById('file-in');
impZ.onclick=()=>fIn.click();
impZ.ondragover=e=>{e.preventDefault();impZ.classList.add('dragover')};impZ.ondragleave=()=>impZ.classList.remove('dragover');
impZ.ondrop=e=>{e.preventDefault();impZ.classList.remove('dragover');if(e.dataTransfer.files.length)doImpMulti(e.dataTransfer.files)};
fIn.onchange=()=>{if(fIn.files.length)doImpMulti(fIn.files);fIn.value=''};
async function doImpMulti(files){
  const res=document.getElementById('imp-result');res.style.display='block';res.className='import-result';
  res.innerHTML='<div style="font-size:13px;color:var(--text2)">èª­ã¿è¾¼ã¿ä¸­...</div>';
  let results=[];let totalNew=0,totalUpd=0,totalSkip=0;
  for(const file of files){
    try{
      const d=JSON.parse(await file.text());
      if(!d.items?.length){results.push({name:file.name,ok:false,msg:'itemsé…åˆ—ãªã—'});continue}
      let a=0,u=0,s=0;
      for(const it of d.items){if(!it.itemId||!it.audio){s++;continue}
        const exists=await gg('items',it.itemId);
        await pp('items',{itemId:it.itemId,audio:it.audio,transcript:it.transcript||null,translation:it.translation||null,tags:it.tags||[],memo:it.memo||'',importedAt:exists?.importedAt||new Date().toISOString()});
        if(exists){u++}else{await pp('cards',{itemId:it.itemId,stability:0,difficulty:0,lastReview:0,reviewCount:0,lapseCount:0});a++}}
      results.push({name:file.name,ok:true,added:a,updated:u,skipped:s,total:d.items.length});
      totalNew+=a;totalUpd+=u;totalSkip+=s;
    }catch(e){results.push({name:file.name,ok:false,msg:e.message})}
  }
  let html=`<div style="font-weight:700;font-size:15px;margin-bottom:8px;color:var(--good)">å®Œäº†: ${totalNew}ä»¶ æ–°è¦ / ${totalUpd}ä»¶ æ›´æ–°</div>`;
  html+='<div style="text-align:left;font-size:12px;color:var(--text2);max-height:200px;overflow-y:auto">';
  results.forEach(r=>{
    if(r.ok) html+=`<div style="padding:4px 0;border-bottom:1px solid var(--border)">ğŸ“„ ${esc(r.name)} <span style="color:var(--text3)">(${r.total}ä»¶)</span> â†’ <b style="color:var(--good)">${r.added}æ–°è¦</b>${r.updated?` <b style="color:var(--accent)">${r.updated}æ›´æ–°</b>` :''}${r.skipped?` <span style="color:var(--text3)">${r.skipped}ä¸æ­£</span>`:''}</div>`;
    else html+=`<div style="padding:4px 0;border-bottom:1px solid var(--border)">ğŸ“„ ${esc(r.name)} â†’ <span style="color:var(--again)">ã‚¨ãƒ©ãƒ¼: ${esc(r.msg)}</span></div>`;
  });
  html+='</div>';
  res.className='import-result ok';res.innerHTML=html;refreshHome();
}

// === Audio ===
let curA=null;
function b2b(b,f){const m=f==='mp3'?'audio/mpeg':'audio/'+f;const d=atob(b);const a=new Uint8Array(d.length);for(let i=0;i<d.length;i++)a[i]=d.charCodeAt(i);return new Blob([a],{type:m})}
function playI(item,rate=1){if(curA){curA.pause();curA=null}curA=new Audio(URL.createObjectURL(b2b(item.audio.data,item.audio.format)));curA.preservesPitch=true;curA.playbackRate=rate;curA.play().catch(()=>{});return curA}

// === Study ===
let sIt=[],sI=0,sSt=0,sEv=[],sRated=false;
document.getElementById('btn-start').onclick=startStudy;
async function startStudy(){
  let items=await ga('items');const cards=await ga('cards');
  if(selTags.size>0)items=items.filter(i=>(i.tags||[]).some(t=>selTags.has(t)));
  if(!items.length){nav('study');document.getElementById('screen-study').innerHTML='<div style="flex:1;display:flex;align-items:center;justify-content:center;color:var(--text2)"><div style="text-align:center"><p>å¯¾è±¡ãªã—</p><button class="btn btn-surface btn-sm" style="margin-top:12px" onclick="nav(\'home\')">æˆ»ã‚‹</button></div></div>';return}
  sched.reset();
  if(studyOrd==='random'){for(let i=items.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[items[i],items[j]]=[items[j],items[i]]}}
  sIt=items;sI=0;sSt=0;sEv=[];sRated=false;nav('study');
  studyOrd==='scheduler'?await pickN():renderS();
}
async function pickN(){
  const cards=await ga('cards'),evals=await ga('evalLog');
  const pool=new Set(sIt.map(i=>i.itemId));
  const id=sched.pick(cards.filter(c=>pool.has(c.itemId)),evals,sEv);
  if(!id){endS();return}
  const item=sIt.find(i=>i.itemId===id);if(!item){endS();return}
  sIt.splice(sIt.indexOf(item),1);sIt.splice(sI,0,item);sSt=0;sRated=false;renderS();
}
function endS(){if(curA){curA.pause();curA=null}nav('home')}
function renderS(){
  const item=sIt[sI];if(!item){endS();return}
  const tot=studyOrd==='scheduler'?'â€”':sIt.length;
  const sg={0:'good',1:'hard',2:'again',3:'again'}[sSt];
  let body='';
  if(sSt===0) body=`<div class="audio-orb" id="aorb"><svg fill="currentColor" viewBox="0 0 24 24"><polygon points="6,4 20,12 6,20"/></svg></div><div class="s-label">Step 1 â€” é€šå¸¸å†ç”Ÿ</div><div class="speed-pill">1.0x</div>`;
  else if(sSt===1) body=`<div class="audio-orb" id="aorb"><svg fill="currentColor" viewBox="0 0 24 24"><polygon points="6,4 20,12 6,20"/></svg></div><div class="s-label">Step 2 â€” ã‚¹ãƒ­ãƒ¼å†ç”Ÿ</div><div class="speed-pill">0.75x</div>`;
  else if(sSt===2){const wds=tok(item.transcript);body=`<div class="s-label fade">Step 3 â€” ã‚¹ã‚¯ãƒªãƒ—ãƒˆ</div><div class="s-text fade" id="tw">${wds.map(w=>/\w/.test(w)?`<span class="word-tap" data-w="${esc(w.toLowerCase())}">${esc(w)}</span>`:esc(w)).join('')}</div>`}
  else{const wds=tok(item.transcript);body=`<div class="s-label">Step 3</div><div class="s-text" id="tw">${wds.map(w=>/\w/.test(w)?`<span class="word-tap" data-w="${esc(w.toLowerCase())}">${esc(w)}</span>`:esc(w)).join('')}</div><div class="s-label fade" style="margin-top:6px">Step 4 â€” æ—¥æœ¬èªè¨³</div><div class="s-text ja fade">${esc(item.translation||'(ç¿»è¨³ãªã—)')}</div>`}

  let nb='';
  if(sSt<2) nb=`<div class="ctrl-row"><button class="btn btn-surface" onclick="replay_()">ã‚‚ã†ä¸€åº¦</button><button class="btn btn-accent" onclick="nextSt()">${sSt===0?'ã‚¹ãƒ­ãƒ¼':'ã‚¹ã‚¯ãƒªãƒ—ãƒˆ'}</button></div>`;
  else if(sSt===2) nb=`<div class="ctrl-row"><button class="btn btn-surface" onclick="replay_()">å†ç”Ÿ</button><button class="btn btn-surface" onclick="nextSt()">æ—¥æœ¬èªè¨³</button></div>`;
  else nb=`<div class="ctrl-row"><button class="btn btn-surface" onclick="replay_()">å†ç”Ÿ</button></div>`;

  let rateHTML='';
  if(sRated){
    rateHTML=`<button class="btn btn-accent btn-block" onclick="goNext()">æ¬¡ã¸ â†’</button>
      <div style="text-align:center;font-size:12px;color:var(--text3)">è©•ä¾¡æ¸ˆã¿ â€” STEPã¯è‡ªç”±ã«ç§»å‹•ã§ãã¾ã™</div>`;
  }else{
    rateHTML=`<div class="rate-row">
        <button class="rate-btn r-again${sg==='again'?' suggest':''}" onclick="doRate(1)">Again</button>
        <button class="rate-btn r-hard${sg==='hard'?' suggest':''}" onclick="doRate(2)">Hard</button>
        <button class="rate-btn r-good${sg==='good'?' suggest':''}" onclick="doRate(3)">Good</button>
        <button class="rate-btn r-easy${sg==='easy'?' suggest':''}" onclick="doRate(4)">Easy</button>
      </div>
      <button class="btn btn-surface btn-sm btn-block" style="opacity:0.5" onclick="doSkip()">ã‚¹ã‚­ãƒƒãƒ—</button>`;
  }

  document.getElementById('screen-study').innerHTML=`
    <div class="study-hdr"><div class="study-prog">${sI+1} / ${tot}</div><button class="study-close" onclick="endS()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 5l8 8M13 5l-8 8"/></svg></button></div>
    <div class="step-dots">${[0,1,2,3].map(i=>`<div class="sdot${i===sSt?' on':i<sSt?' done':''}"></div>`).join('')}</div>
    <div class="study-body">${body}</div>
    <div class="study-ctrls">${nb}${rateHTML}</div>`;
  if(!sRated&&sSt<=2) doPlay(item,sSt===1?0.75:1);
  setTimeout(()=>initWT(item.itemId),50);
}
function doPlay(item,rate){const a=playI(item,rate);addL('playLog',{itemId:item.itemId,playedAt:new Date().toISOString(),speed:rate===1?'normal':'slow',source:'manual'});a.onplay=()=>{const o=document.getElementById('aorb');if(o)o.classList.add('playing')};a.onended=()=>{const o=document.getElementById('aorb');if(o)o.classList.remove('playing')}}
function replay_(){const item=sIt[sI];if(item)doPlay(item,sSt===1?0.75:1)}
function nextSt(){if(sSt<3){if(curA)curA.pause();sSt++;renderS()}}
function doSkip(){if(curA)curA.pause();sI++;sSt=0;sRated=false;studyOrd==='scheduler'?pickN():sI>=sIt.length?endS():renderS()}
async function doRate(g){
  const item=sIt[sI];if(!item||sRated)return;
  await addL('evalLog',{itemId:item.itemId,evaluatedAt:new Date().toISOString(),rating:g});
  const card=await gg('cards',item.itemId)||{itemId:item.itemId,stability:0,difficulty:0,lastReview:0,reviewCount:0,lapseCount:0};
  const upd=fsrs.review(card,g,Math.floor(Date.now()/86400000));upd.itemId=item.itemId;await pp('cards',upd);
  sEv.push(item.itemId);sRated=true;renderS();
  toast(['','Again','Hard','Good','Easy'][g]+' ã§è¨˜éŒ²');
}
function goNext(){if(curA)curA.pause();sI++;sSt=0;sRated=false;studyOrd==='scheduler'?pickN():sI>=sIt.length?endS():renderS()}
// Word tap
async function initWT(iid){
  const el=document.getElementById('tw');if(!el)return;
  const ex=await byIdx('wordList','itemId',iid);const ew=new Set(ex.map(w=>w.word));
  el.querySelectorAll('.word-tap').forEach(sp=>{
    const w=sp.dataset.w;if(ew.has(w))sp.classList.add('marked');
    sp.onclick=async()=>{
      if(sp.classList.contains('marked')){const all=await byIdx('wordList','itemId',iid);const f=all.find(x=>x.word===w);if(f)await dd('wordList',f.id);sp.classList.remove('marked');toast(`"${w}" å‰Šé™¤`)}
      else{const aw=await byIdx('wordList','word',w);if(!aw.find(x=>x.sourceItemId===iid))await addL('wordList',{word:w,sourceItemId:iid,addedAt:new Date().toISOString()});sp.classList.add('marked');toast(`"${w}" ç™»éŒ²`)}
    };
  });
}
function tok(t){return t?t.split(/(\s+|(?=[.,!?;:'"()\-]))/g).filter(Boolean):['(ã‚¹ã‚¯ãƒªãƒ—ãƒˆãªã—)']}

// === Auto Play ===
let autoOn=false,autoI=0,autoIt=[];
document.getElementById('btn-auto').onclick=startAuto;
async function startAuto(){
  let items=await ga('items');
  if(selTags.size>0)items=items.filter(i=>(i.tags||[]).some(t=>selTags.has(t)));
  if(!items.length){toast('ã‚¢ã‚¤ãƒ†ãƒ ãªã—');return}
  if(studyOrd==='random'){for(let i=items.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[items[i],items[j]]=[items[j],items[i]]}}
  autoIt=items;autoI=0;autoOn=true;nav('auto');autoNext();
}
function renderAuto(){
  const item=autoIt[autoI];
  document.getElementById('screen-auto').innerHTML=`
    <div class="s-label" style="margin-bottom:8px">${autoI+1} / ${autoIt.length}</div>
    <div class="auto-orb" id="ao"><svg fill="currentColor" viewBox="0 0 24 24"><polygon points="6,4 20,12 6,20"/></svg></div>
    <div style="font-size:13px;color:var(--text2);margin-top:8px">è‡ªå‹•å†ç”Ÿä¸­</div>
    <div class="auto-transcript">${esc(item?.transcript||'')}</div>
    <button class="auto-stop" onclick="stopAuto()"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></button>
    <div style="font-size:11px;color:var(--text3)">åœæ­¢</div>`;
}
async function autoNext(){
  if(!autoOn||autoI>=autoIt.length){stopAuto();return}
  const item=autoIt[autoI];renderAuto();
  await addL('playLog',{itemId:item.itemId,playedAt:new Date().toISOString(),speed:'normal',source:'auto'});
  const a1=playI(item,1);const ao=document.getElementById('ao');if(ao)ao.classList.add('playing');
  await wA(a1);if(!autoOn)return;await sl(1500);if(!autoOn)return;
  await addL('playLog',{itemId:item.itemId,playedAt:new Date().toISOString(),speed:'slow',source:'auto'});
  playI(item,0.75);await wA(curA);if(!autoOn)return;await sl(2500);if(!autoOn)return;
  autoI++;autoNext();
}
function stopAuto(){autoOn=false;if(curA){curA.pause();curA=null}nav('home')}
function wA(a){return new Promise(r=>{if(!a)return r();a.onended=r;a.onerror=r})}
function sl(ms){return new Promise(r=>setTimeout(r,ms))}

// === Data ===
document.querySelectorAll('.data-tab').forEach(t=>t.onclick=()=>{document.querySelectorAll('.data-tab,.data-section').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.getElementById('dt-'+t.dataset.tab).classList.add('active');if(t.dataset.tab==='words')refreshW()});
let dFilt='all';
async function refreshData(){await refreshIL();await refreshW();document.getElementById('app-ver').textContent='App '+APP_VER}
async function refreshIL(){
  const items=await ga('items'),cards=await ga('cards'),evals=await ga('evalLog'),plays=await ga('playLog');
  const cm={};cards.forEach(c=>cm[c.itemId]=c);
  const fE=document.getElementById('data-filter');
  fE.innerHTML=['all','unseen','learning','perfect'].map(f=>`<span class="tag${dFilt===f?' active':''}" data-f="${f}">${{all:'ã™ã¹ã¦',unseen:'æœªå­¦ç¿’',learning:'å­¦ç¿’ä¸­',perfect:'å®Œç’§'}[f]}</span>`).join('');
  fE.querySelectorAll('.tag').forEach(t=>t.onclick=()=>{dFilt=t.dataset.f;refreshIL()});
  let fl=items;
  if(dFilt!=='all')fl=items.filter(it=>{const c=cm[it.itemId];if(dFilt==='unseen')return!c||c.reviewCount===0;const ie=evals.filter(e=>e.itemId===it.itemId).sort((a,b)=>b.evaluatedAt.localeCompare(a.evaluatedAt));const ip=ie.length>=3&&ie.slice(0,3).every(e=>e.rating>=3);return dFilt==='perfect'?ip:dFilt==='learning'?c&&c.reviewCount>0&&!ip:true});
  const lE=document.getElementById('item-list');
  if(!fl.length){lE.innerHTML='<div style="text-align:center;padding:24px;color:var(--text3);font-size:13px">ã‚¢ã‚¤ãƒ†ãƒ ãªã—</div>';return}
  lE.innerHTML='';
  fl.forEach(it=>{const pc=plays.filter(p=>p.itemId===it.itemId).length,ec=evals.filter(e=>e.itemId===it.itemId).length;
    const ie=evals.filter(e=>e.itemId===it.itemId).sort((a,b)=>b.evaluatedAt.localeCompare(a.evaluatedAt));
    const c=cm[it.itemId];let st_='âšªæœªå­¦ç¿’';if(c&&c.reviewCount>0){st_=ie.length>=3&&ie.slice(0,3).every(e=>e.rating>=3)?'ğŸŸ¢å®Œç’§':'ğŸ”µå­¦ç¿’ä¸­'}
    const r=document.createElement('div');r.className='item-row fade';
    r.innerHTML=`<button class="item-play" data-id="${it.itemId}"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><polygon points="6,4 20,12 6,20"/></svg></button><div class="item-info"><div class="item-t">${esc(it.transcript||'(ãªã—)')}</div><div class="item-t2">${esc(it.translation||'')}</div><div class="item-tags"><span class="mini-tag">${st_}</span><span class="mini-tag">â–¶${pc} â˜…${ec}</span>${(it.tags||[]).map(t=>`<span class="mini-tag">${esc(t)}</span>`).join('')}</div></div><button class="item-del" data-id="${it.itemId}"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>`;
    lE.appendChild(r)});
  lE.querySelectorAll('.item-play').forEach(b=>b.onclick=async()=>{const it=await gg('items',b.dataset.id);if(it)playI(it)});
  lE.querySelectorAll('.item-del').forEach(b=>b.onclick=()=>confirm_('å‰Šé™¤','ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\næˆç¸¾ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚',async()=>{await dd('items',b.dataset.id);refreshIL();refreshHome()}));
}
async function refreshW(){
  const ws=await ga('wordList');const lE=document.getElementById('word-list');
  if(!ws.length){lE.innerHTML='<div style="text-align:center;padding:24px;color:var(--text3);font-size:13px">å˜èªãªã—</div>';return}
  ws.sort((a,b)=>a.word.localeCompare(b.word));lE.innerHTML='';
  ws.forEach(w=>{const r=document.createElement('div');r.className='word-row fade';r.innerHTML=`<div><div class="word-text">${esc(w.word)}</div><div class="word-src">${esc(w.addedAt?.slice(0,10)||'')}</div></div><button class="item-del" data-id="${w.id}"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg></button>`;lE.appendChild(r)});
  lE.querySelectorAll('.item-del').forEach(b=>b.onclick=async()=>{await dd('wordList',parseInt(b.dataset.id));refreshW()});
}
document.getElementById('btn-export-words').onclick=async()=>{const ws=await ga('wordList');if(!ws.length){toast('å˜èªãªã—');return}ws.sort((a,b)=>a.word.localeCompare(b.word));const b=new Blob([ws.map(w=>w.word).join('\n')],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='word-list.txt';a.click();toast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†')};
document.getElementById('btn-clear-words').onclick=()=>confirm_('å˜èªãƒªã‚¹ãƒˆå…¨å‰Šé™¤','çŸ¥ã‚‰ãªã„å˜èªãƒªã‚¹ãƒˆã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',async()=>{await cc('wordList');refreshW();toast('å‰Šé™¤å®Œäº†')});
document.getElementById('btn-reset-progress').onclick=()=>confirm_('æˆç¸¾ãƒªã‚»ãƒƒãƒˆ','ã‚«ãƒ¼ãƒ‰çŠ¶æ…‹ãƒ»å†ç”Ÿãƒ­ã‚°ãƒ»è©•ä¾¡ãƒ­ã‚°ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚\nã‚¢ã‚¤ãƒ†ãƒ æœ¬ä½“ã¯æ®‹ã‚Šã¾ã™ã€‚',async()=>{await cc('cards');await cc('playLog');await cc('evalLog');const items=await ga('items');for(const it of items)await pp('cards',{itemId:it.itemId,stability:0,difficulty:0,lastReview:0,reviewCount:0,lapseCount:0});refreshData();refreshHome();toast('ãƒªã‚»ãƒƒãƒˆå®Œäº†')});
document.getElementById('btn-delete-all').onclick=()=>confirm_('å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤','ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚',async()=>{await cc('items');await cc('cards');await cc('playLog');await cc('evalLog');await cc('wordList');refreshData();refreshHome();toast('å…¨å‰Šé™¤å®Œäº†')});

// === Utils ===
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// === Init ===
// === Init ===
const APP_VER='v3';
(async()=>{
  await openDB();refreshHome();
  if('serviceWorker' in navigator){
    const reg=await navigator.serviceWorker.register('./sw.js').catch(()=>null);
    if(reg){
      reg.addEventListener('updatefound',()=>{
        const nw=reg.installing;
        if(nw)nw.addEventListener('statechange',()=>{
          if(nw.state==='activated'){toast('ã‚¢ãƒ—ãƒªæ›´æ–°ã‚ã‚Š â€” å†èª­ã¿è¾¼ã¿ã—ã¾ã™');setTimeout(()=>location.reload(),1500)}
        });
      });
      // Also check immediately on load
      reg.update().catch(()=>{});
    }
  }
  console.log('Listening App',APP_VER,'ready');
})();
</script>
</body>
</html>
